<!DOCTYPE html>
<html lang="en">
<head><head>
    <meta name="google-site-verification" content="9vIieCe-Qpd78QOmBl63rGtIVbhY6sYyuxX3j8XWBA4" />
    <meta name="baidu-site-verification" content="LRrmH41lz7" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="异步编程">
    
    <meta name="keyword"  content="Redis, Go, 微服务, PHP, Git, Bash">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>PHP专业笔记（七十）-怀府风的博客 | Arvin&#39;s Blog</title>

    <link rel="canonical" href="/2019/06/post/php-section-70.html">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/syntax.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>
</head>
</head>

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">怀府小阁</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
                    
                    <li>
                        <a href="/categories/algorithms">algorithms</a>
                    </li>
                    
                    <li>
                        <a href="/categories/go">go</a>
                    </li>
                    
                    <li>
                        <a href="/categories/java">java</a>
                    </li>
                    
                    <li>
                        <a href="/categories/linux">linux</a>
                    </li>
                    
                    <li>
                        <a href="/categories/php">php</a>
                    </li>
                    
                    <li>
                        <a href="/categories/%E5%B7%A5%E5%85%B7">工具</a>
                    </li>
                    
                    <li>
                        <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a>
                    </li>
                    
                    <li>
                        <a href="/categories/%E9%9A%8F%E7%AC%94">随笔</a>
                    </li>
                    

                    
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header{
        background-image: url('/img/head_bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                       
                       <a class="tag" href="/tags/php" title="PHP">
                           PHP
                        </a>
                       
                    </div>
                    <h1>PHP专业笔记（七十）</h1>
                    <h2 class="subheading"></h2>
                    <span  class="meta">Posted by 怀府风 on Sunday, June 9, 2019
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

        		
                        <header>
                        <h2>TOC</h2>
                        </header>
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#异步编程">异步编程</a>
      <ul>
        <li><a href="#1-生成器的优点">1. 生成器的优点</a></li>
        <li><a href="#2-使用icicle时间循环">2. 使用Icicle时间循环</a></li>
        <li><a href="#3-proc_open生成非阻塞进程">3. proc_open()生成非阻塞进程</a></li>
        <li><a href="#4-使用事件和dio读取串行接口">4. 使用事件和DIO读取串行接口</a></li>
        <li><a href="#5-event扩展的http客户端">5. Event扩展的HTTP客户端</a></li>
        <li><a href="#6-基于ev扩展的http客户端请求">6. 基于Ev扩展的HTTP客户端请求</a></li>
        <li><a href="#7-使用amp事件循环">7 使用AMP事件循环</a></li>
      </ul>
    </li>
  </ul>
</nav>
        		
        		<h2 id="异步编程">异步编程</h2>
<h3 id="1-生成器的优点">1. 生成器的优点</h3>
<p>PHP5.5提供了生成器和yield关键字，这允许我们想同步代码一样编写异步代码。</p>
<p><code>yield</code>表达式负责将控制结构交还给调用代码，并在这个位置提供恢复点。可以通过yield表达式发送一个值。这个表达式的返回值要么是<code>null</code>，要么是<code>Generator::send()</code>的值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">function reverse_range($i) {
    // 仅仅在这个函数中存在yield关键字就使得它成为一个生成器。
    do {
        //$i 在恢复点之间保留着
        print yield $i;
    } while (--$i &gt; 0);
}
$gen = reverse_range(5);
print $gen-&gt;current();
$gen-&gt;send(&#34;injected!&#34;); // send 也会唤起这个生成器

foreach ($gen as $val) { //循环处理迭代器，在每个每个迭代中唤起	
    echo $val;
}
// Output: 5injected!4321
</code></pre></div><p>协程可以使用这种机制来等待生成器生成Awaitable的yield（通过将自身注册于用于解析的回调）在Awaitables的yield解析的时候执行生成器。</p>
<h3 id="2-使用icicle时间循环">2. 使用Icicle时间循环</h3>
<p><a href="https://github.com/icicleio/icicle">Icicle</a>使用Awaitable和生成器来创建协程。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">require __DIR__ . &#39;/vendor/autoload.php&#39;;

use Icicle\Awaitable;
use Icicle\Coroutine\Coroutine; use Icicle\Loop;

$generator = function (float $time) { 
    try {
        //设置$start的值为microtime()返回之后大约$time秒
        $start = yield Awaitable\resolve(microtime(true))-&gt;delay($time); 
        echo &#34;Sleep time: &#34;, microtime(true) - $start, &#34;\n&#34;;
      
        // 在rejected awaitable进入协程之后跑出异常
        return yield Awaitable\reject(new Exception(&#39;Rejected awaitable&#39;)); 
    } catch (Throwable $e) { // 获取 awaitable 拒绝的原因
        echo &#34;Caught exception: &#34;, $e-&gt;getMessage(), &#34;\n&#34;; 
    }
    
    return yield Awaitable\resolve(&#39;Coroutine completed&#39;);                                
};

// 协程休眠1.2秒之后，解析一个字符串
$coroutine = new Coroutine($generator(1.2)); 
$coroutine-&gt;done(function (string $data) {
    echo $data, &#34;\n&#34;; 
});

Loop\run();

//输出
Sleep time: 1.2049908638
Caught exception: Rejected awaitable
Coroutine completed
</code></pre></div><h3 id="3-proc_open生成非阻塞进程">3. proc_open()生成非阻塞进程</h3>
<p>除非你安装了<code>pthread</code>扩展，否则PHP不支持并行运行代码。有时可以通过使用<code>proc_open()</code>和<code>stream_set_blocking()</code>并且异步读取其输出来实现这点。</p>
<p>如果我们把代码拆分到多个进程，我们可以像多个超进程一样运行代码。然后使用<a href="https://www.php.net/manual/zh/function.stream-set-blocking.php">stream_set_blocking()</a>来让每个子进程也不阻塞。这意味着我们可以创建多个子进程，然后在循环中检查他们的输出(简单的就是事件循环)，直到它们都执行完毕。</p>
<p>作为一个例子，我们可以有一个运行一个循环的子进程，在每个迭代中sleep100-1000ms之间的随机时间（注意：对于一个子进程所有的延迟时间是一样的。）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#75715e">//subprocess.php
</span><span style="color:#75715e"></span>$name <span style="color:#f92672">=</span> $argv[<span style="color:#ae81ff">1</span>];
$delay <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">100</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>;
<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">$name</span><span style="color:#e6db74"> delay: </span><span style="color:#e6db74">{</span>$delay<span style="color:#e6db74">}</span><span style="color:#e6db74">ms&#34;</span>);

<span style="color:#66d9ef">for</span> ($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>; $i<span style="color:#f92672">++</span>) { 
    <span style="color:#a6e22e">usleep</span>($delay <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>); 
    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">$name</span><span style="color:#e6db74">: </span><span style="color:#e6db74">$i\n</span><span style="color:#e6db74">&#34;</span>);
}
</code></pre></div><p>然后主进程会生成子进程，然后读取它们的输出。我们把它拆分到小块：</p>
<ul>
<li>使用<a href="https://www.php.net/manual/zh/function.proc-open.php">proc_open()</a>生成子进程</li>
<li>使用<a href="https://www.php.net/manual/zh/function.stream-set-blocking.php">stream_set_blocking()</a>让每个子进程不阻塞</li>
<li>循环，直到所有的子进程结束，使用<a href="https://www.php.net/manual/zh/function.proc-get-status.php">proc_get_status()</a>进行判断</li>
<li>在子进程中使用<a href="https://www.php.net/manual/zh/function.fclose.php">fclose()</a>使用输出管道关闭文件句柄，使用<a href="https://www.php.net/manual/zh/function.proc-close.php">proc_close()</a>关闭进程句柄</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#75715e">//non-blocking-proc_open.php
</span><span style="color:#75715e">//每个子进程的文件描述
</span><span style="color:#75715e"></span>$descriptors <span style="color:#f92672">=</span> [
    <span style="color:#ae81ff">0</span> <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;pipe&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>], <span style="color:#75715e">//stdin
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">1</span> <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;pipe&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>], <span style="color:#75715e">//stdout
</span><span style="color:#75715e"></span>];

$pipes <span style="color:#f92672">=</span> [];
$processes <span style="color:#f92672">=</span> [];
<span style="color:#66d9ef">foreach</span> (<span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">as</span> $i) {
    <span style="color:#75715e">//生成子进程
</span><span style="color:#75715e"></span>    $proc <span style="color:#f92672">=</span> <span style="color:#a6e22e">proc_open</span>(<span style="color:#e6db74">&#34;php subprocess.php proc&#34;</span> <span style="color:#f92672">.</span> $i, $descriptors, $procPipes);
    $processes[$i] <span style="color:#f92672">=</span> $proc;
    <span style="color:#75715e">//设置子进程非阻塞 只是输出管道
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">stream_set_blocking</span>($procPipes[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">0</span>);
    $pipes[$i] <span style="color:#f92672">=</span> $procPipes;
}

<span style="color:#75715e">//运行循环直到所有子进程执行完毕
</span><span style="color:#75715e"></span><span style="color:#66d9ef">while</span>(<span style="color:#a6e22e">array_filter</span>($processes, <span style="color:#66d9ef">function</span>($proc) { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proc_get_status</span>($proc)[<span style="color:#e6db74">&#39;running&#39;</span>];})) {
    <span style="color:#66d9ef">foreach</span>(<span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">as</span> $i) {
        <span style="color:#a6e22e">usleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>); <span style="color:#75715e">//10ms
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//读取所有有效的输出
</span><span style="color:#75715e"></span>        $str <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>($pipes[$i][<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">1024</span>);
        <span style="color:#66d9ef">if</span> ($str) {
            <span style="color:#a6e22e">printf</span>($str);
        }
    }
}

<span style="color:#75715e">//关闭所有管道和进程
</span><span style="color:#75715e"></span><span style="color:#66d9ef">foreach</span>(<span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">as</span> $i) {
    <span style="color:#a6e22e">fclose</span>($pipes[$i][<span style="color:#ae81ff">1</span>]);
    <span style="color:#a6e22e">proc_close</span>($processes[$i]);
}
</code></pre></div><p>然后输出来自3个子进程的混合体，正如fread()读取的一样(注意，在本示例中，<code>proc1</code>的结束时间早于另外两个)。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ php non-blocking-proc_open.php
proc1 delay: 200ms
proc2 delay: 1000ms
proc3 delay: 800ms
proc1: <span style="color:#ae81ff">0</span>
proc1: <span style="color:#ae81ff">1</span>
proc1: <span style="color:#ae81ff">2</span>
proc1: <span style="color:#ae81ff">3</span>
proc3: <span style="color:#ae81ff">0</span>
proc1: <span style="color:#ae81ff">4</span>
proc2: <span style="color:#ae81ff">0</span>
proc3: <span style="color:#ae81ff">1</span>
proc2: <span style="color:#ae81ff">1</span>
proc3: <span style="color:#ae81ff">2</span>
proc2: <span style="color:#ae81ff">2</span>
proc3: <span style="color:#ae81ff">3</span>
proc2: <span style="color:#ae81ff">3</span>
proc3: <span style="color:#ae81ff">4</span>
proc2: <span style="color:#ae81ff">4</span>
</code></pre></div><h3 id="4-使用事件和dio读取串行接口">4. 使用事件和DIO读取串行接口</h3>
<p><a href="https://www.php.net/manual/zh/book.event.php">Event</a>扩展现在不能够识别<a href="https://www.php.net/manual/zh/book.dio.php">DIO流</a>。没有很好的方法来获取封装在DIO资源中的文件描述符。但是有一个解决办法：</p>
<ul>
<li>使用<code>fopen()</code>打开某个端口的流</li>
<li>设置这个流不阻塞使用<code>stream_set_blocking()</code></li>
<li>使用<a href="https://www.php.net/manual/zh/eventutil.getsocketfd.php">EventUtil::getSocketFd()</a>从流中获取数字文件描述符</li>
<li>然后将数字文件描述符传递给<code>dio_fdopen()</code>(当前没有记录)，然后获取DIO资源</li>
<li>在文件描述符上面添加一个回调Event，监听读取<code>Event</code></li>
<li>在回调中读取有效的数据，然后根据你应用的逻辑进行处理</li>
</ul>
<p><strong>dio.php</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Scanner</span> {
    <span style="color:#66d9ef">protected</span> $port;  <span style="color:#75715e">//端口地址 例如 /dev/pts/5
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> $fd; <span style="color:#75715e">//数字文件描述符
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> $base; <span style="color:#75715e">//EventBase
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> $dio; <span style="color:#75715e">//dio资源
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> $e_open; <span style="color:#75715e">//Event
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> $e_read; <span style="color:#75715e">//Event
</span><span style="color:#75715e"></span>    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($port) {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> $port;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventBase</span>();
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __destruct() {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exit</span>();
        
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_open</span>) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_open</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">free</span>();
        }
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_read</span>) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_read</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">free</span>();
        }
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dio</span>) {
            <span style="color:#a6e22e">dio_close</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dio</span>);
        }
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>() {
        $stream <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">port</span>, <span style="color:#e6db74">&#39;rb&#39;</span>);
        <span style="color:#a6e22e">stream_set_blocking</span>($stream, <span style="color:#66d9ef">false</span>);
        
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">EventUtil</span><span style="color:#f92672">::</span><span style="color:#a6e22e">getSocketFd</span>($stream);
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#a6e22e">fprintf</span>(<span style="color:#a6e22e">STDERR</span>, <span style="color:#e6db74">&#34;Failed attach to port, events: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, $events);
            <span style="color:#66d9ef">return</span>;
        }
        
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_open</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Event</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">Event</span><span style="color:#f92672">::</span><span style="color:#a6e22e">WRITE</span>, [$this, <span style="color:#e6db74">&#39;_onOpen&#39;</span>]);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_open</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">add</span>();
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dispatch</span>();
        
        <span style="color:#a6e22e">fclose</span>($stream);
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_onOpen</span>($fd, $events) {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_open</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">del</span>();
        
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dio</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dio_fdopen</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>);
        <span style="color:#75715e">//调用dio其他方法
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">dio_tcsetattr</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dio</span>, [
            <span style="color:#e6db74">&#39;baud&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">9600</span>,
            <span style="color:#e6db74">&#39;bits&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">8</span>,
            <span style="color:#e6db74">&#39;stop&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>,
            <span style="color:#e6db74">&#39;parity&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>
        ]);
        
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_read</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Event</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">Event</span><span style="color:#f92672">::</span><span style="color:#a6e22e">READ</span><span style="color:#f92672">|</span><span style="color:#a6e22e">Event</span><span style="color:#f92672">::</span><span style="color:#a6e22e">PERSIST</span>, [$this, <span style="color:#e6db74">&#39;_onRead&#39;</span>]);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">e_read</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">add</span>();
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_onRead</span>($fd, $events) {
        <span style="color:#66d9ef">while</span> ($data <span style="color:#f92672">=</span> <span style="color:#a6e22e">dio_read</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dio</span>, <span style="color:#ae81ff">1</span>)) {
            <span style="color:#a6e22e">var_dump</span>($data);
        }
    }
}

<span style="color:#75715e">//修改端口参数
</span><span style="color:#75715e"></span>$scanner <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Scanner</span>(<span style="color:#e6db74">&#39;/dev/pts/5&#39;</span>);
$scanner<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">run</span>();
</code></pre></div><p><strong>测试</strong></p>
<p>在终端A上运行下面的命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$ socat -d -d pty,raw,echo=0 pty,raw,echo=0
2016/12/01 18:04:06 socat[16750] N PTY is /dev/pts/5
2016/12/01 18:04:06 socat[16750] N PTY is /dev/pts/8
2016/12/01 18:04:06 socat[16750] N starting data transfer loop with FDs [5,5] and [7,7]
</code></pre></div><p>输出可能是不同的。使用前两行中的PTYs（这里是<code>/dev/pts/5</code>和<code>/dev/pts/8</code>）。</p>
<p>在终端B中运行上面提到的脚本。你可能需要root权限。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo php dio.php
</code></pre></div><p>在终端C中发送下面的内容到第一个PTY：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ echo test &gt; /dev/pts/8
string<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;t&#34;</span>
string<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;e&#34;</span>
string<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;s&#34;</span>
string<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;t&#34;</span>
string<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><h3 id="5-event扩展的http客户端">5. Event扩展的HTTP客户端</h3>
<p>这是一个简单的际遇Event扩展的HTTP客户端。</p>
<p>这个类允许发送一系列的HTTP请求，然后异步的运行它们。</p>
<p>http-client.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHttpClient</span> {
   <span style="color:#75715e">//@var EventBase
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">protected</span> $base;
   <span style="color:#75715e">//@var EventHttpConnection的数组实例
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">protected</span> $connections <span style="color:#f92672">=</span> [];
   
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct() {
       $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventBase</span>();
   }
  
  <span style="color:#e6db74">/**
</span><span style="color:#e6db74">   * 分发所有等待中的请求
</span><span style="color:#e6db74">   *
</span><span style="color:#e6db74">   * @return void
</span><span style="color:#e6db74">   */</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>() {
      $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dispatch</span>();
  }
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __destruct() {
      <span style="color:#75715e">//显式销毁连接，不等待GC
</span><span style="color:#75715e"></span>      <span style="color:#75715e">//否则，EventBase可以更早的释放
</span><span style="color:#75715e"></span>      $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">connections</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
  }
  
  <span style="color:#e6db74">/**
</span><span style="color:#e6db74">   * @brief 添加一个等待的HTTP请求
</span><span style="color:#e6db74">   *
</span><span style="color:#e6db74">   * @param string $address Hostname或者IP
</span><span style="color:#e6db74">   * @param int $port 端口号
</span><span style="color:#e6db74">   * @param array $headers 额外的HTTP头
</span><span style="color:#e6db74">   * @param int $cmd 一个EventHttpRequest::CMD_*_constant
</span><span style="color:#e6db74">   * @param string $resource HTTP请求资源 &#39;/page?a=b&amp;c=d&#39;
</span><span style="color:#e6db74">   *
</span><span style="color:#e6db74">   * @return EventHttpRequest|false
</span><span style="color:#e6db74">   */</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addRequest</span>($address, $port, <span style="color:#66d9ef">array</span> $headers, $cmd <span style="color:#f92672">=</span> <span style="color:#a6e22e">EventHttpRequest</span><span style="color:#f92672">::</span><span style="color:#a6e22e">CMD_GET</span>, $resource <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/&#39;</span>) {
      $conn <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventHttpConnection</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span>, <span style="color:#66d9ef">null</span>, $address, $port);
      $conn<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setTimeout</span>(<span style="color:#ae81ff">5</span>);
    
      $req <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventHttpRequest</span>([$this, <span style="color:#e6db74">&#39;_requestHandler&#39;</span>], $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">base</span>);
      
      <span style="color:#66d9ef">foreach</span>($headers <span style="color:#66d9ef">as</span> $k <span style="color:#f92672">=&gt;</span> $v) {
          $req<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addHeader</span>($k, $v, <span style="color:#a6e22e">EventHttpRequest</span><span style="color:#f92672">::</span><span style="color:#a6e22e">OUTPUT_HEADER</span>);
      }
      $req<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addHeader</span>(<span style="color:#e6db74">&#39;Host&#39;</span>, $address, <span style="color:#a6e22e">EventHttpRequest</span><span style="color:#f92672">::</span><span style="color:#a6e22e">OUTPUT_HEADER</span>);
      $req<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addHeader</span>(<span style="color:#e6db74">&#39;Connection&#39;</span>, <span style="color:#e6db74">&#39;close&#39;</span>, <span style="color:#a6e22e">EventHttpRequest</span><span style="color:#f92672">::</span><span style="color:#a6e22e">OUTPUT_HEADER</span>);
      <span style="color:#66d9ef">if</span>($conn<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">makeRequest</span>($req, $cmd, $resource)) {
          $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">connections</span>[] <span style="color:#f92672">=</span> $conn;
          <span style="color:#66d9ef">return</span> $req;
      }
    
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
  }
  
  <span style="color:#e6db74">/**
</span><span style="color:#e6db74">   * @brief 处理HTTP请求
</span><span style="color:#e6db74">   *
</span><span style="color:#e6db74">   * @param EventHttpRequest $req
</span><span style="color:#e6db74">   * @param mixed $unused
</span><span style="color:#e6db74">   *
</span><span style="color:#e6db74">   * @return void 
</span><span style="color:#e6db74">   */</span> 
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_requestHandler</span>($req, $unused) {
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_null</span>($req)) {
          <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Timed out</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
      } <span style="color:#66d9ef">else</span> {
          $response_code <span style="color:#f92672">=</span> $req<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getResponseCode</span>();
        
          <span style="color:#66d9ef">if</span>($response_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
              <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Connection refuesd</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
          } <span style="color:#66d9ef">elseif</span> ($response_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>) {
              <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Unexpected response: </span><span style="color:#e6db74">$response_code\n</span><span style="color:#e6db74">&#34;</span>;
          } <span style="color:#66d9ef">else</span> {
              <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Success: </span><span style="color:#e6db74">$response_code\n</span><span style="color:#e6db74">&#34;</span>;
              $buf <span style="color:#f92672">=</span> $req<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getInputBuffer</span>();
              <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Body:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
              <span style="color:#66d9ef">while</span>($s <span style="color:#f92672">=</span> $buf<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">readLine</span>(<span style="color:#a6e22e">EventBuffer</span><span style="color:#f92672">::</span><span style="color:#a6e22e">EOL_ANY</span>)) {
                  <span style="color:#66d9ef">echo</span> $s, <span style="color:#a6e22e">PHP_EOL</span>;
              }
          }
      }
  }
}

$address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my-host.local&#34;</span>;
$port <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>;
$headers <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;User-Agent&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;My-User-Agent/1.0&#39;</span>,];

$clients <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MyHttpClient</span>();

<span style="color:#75715e">//添加等待的请求
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> ($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; $i<span style="color:#f92672">++</span>) {
    $client<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addRequest</span>($address, $port, $headers, <span style="color:#a6e22e">EventHttpRequest</span><span style="color:#f92672">::</span><span style="color:#a6e22e">CMD_GET</span>, <span style="color:#e6db74">&#39;test.php/?a=&#39;</span> <span style="color:#f92672">.</span> $i);
}

<span style="color:#75715e">//发起请求
</span><span style="color:#75715e"></span>$client<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">run</span>();
</code></pre></div><p><strong>test.php</strong></p>
<p>这是服务端的简单示例脚本：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;GET: &#39;</span>, <span style="color:#a6e22e">var_export</span>($_GET, <span style="color:#66d9ef">true</span>), <span style="color:#a6e22e">PHP_EOL</span>;
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;User-Agent: &#39;</span>, $_SERVER[<span style="color:#e6db74">&#39;HTTP_USER_AGENT&#39;</span>] <span style="color:#f92672">??</span> <span style="color:#e6db74">&#39;(none)&#39;</span>, <span style="color:#a6e22e">PHP_EOL</span>;
</code></pre></div><p><strong>用例</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">php http-client.php
</code></pre></div><p>示例的输出</p>
<pre><code>Success: 200
Body:
GET: array (
    'a' =&gt; '1', 
)
User-Agent: My-User-Agent/1.0
Success: 200
Body:
GET: array (
    'a' =&gt; '0', 
)
User-Agent: My-User-Agent/1.0
Success: 200
Body:
GET: array (
    'a' =&gt; '3', 
)
...
</code></pre><p>注意，这个代码是设计在<a href="https://php.net/manual/en/features.commandline.introduction.php">CLI SAPI</a>中长期运行的。</p>
<h3 id="6-基于ev扩展的http客户端请求">6. 基于Ev扩展的HTTP客户端请求</h3>
<p>这个是基于<a href="https://pecl.php.net/package/ev">Ev</a>扩展的HTTP客户端请求例子。</p>
<p>Ev扩展实现了一个简单但功能强大的通用Event循环。它不提供特定网络的观察者程序，但是<a href="http://docs.php.net/manual/zh/class.evio.php">I/O的观察者程序</a>可以用来异步处理<a href="http://docs.php.net/manual/zh/book.sockets.php">sockets</a>。</p>
<p>下面的代码显式了如何安排HTTP的并行请求。</p>
<p><strong>http-client.php</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHttpRequest</span> {
    <span style="color:#75715e">// @var MyHttpClient
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $http_client;
    <span style="color:#75715e">// @var string
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $address; 
    <span style="color:#75715e">// @var string HTTP resource such as /page?get=param 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $resource;
    <span style="color:#75715e">// @var string HTTP method such as GET, POST etc.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $method;
    <span style="color:#75715e">// @var int
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $service_port; 
    <span style="color:#75715e">// @var resource Socket 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $socket;
    <span style="color:#75715e">// @var double Connection timeout in seconds. 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">10.</span>;
    <span style="color:#75715e">// @var int Chunk size in bytes for socket_recv()
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $chunk_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>;
    <span style="color:#75715e">// @var EvTimer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $timeout_watcher;
    <span style="color:#75715e">// @var EvIo
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $write_watcher;
    <span style="color:#75715e">// @var EvIo
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $read_watcher;
    <span style="color:#75715e">// @var EvTimer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $conn_watcher;
    <span style="color:#75715e">// @var string buffer for incoming data
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $buffer;
    <span style="color:#75715e">// @var array errors reported by sockets extension in non-blocking mode. 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> $e_nonblocking <span style="color:#f92672">=</span> [
        <span style="color:#ae81ff">11</span>, <span style="color:#75715e">// EAGAIN or EWOULDBLOCK
</span><span style="color:#75715e"></span>        <span style="color:#ae81ff">115</span>, <span style="color:#75715e">// EINPROGRESS 
</span><span style="color:#75715e"></span>    ];

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @param MyHttpClient $client
</span><span style="color:#e6db74">     * @param string $host Hostname, e.g. google.co.uk
</span><span style="color:#e6db74">     * @param string $resource HTTP resource, e.g. /page?a=b&amp;c=d
</span><span style="color:#e6db74">     * @param string $method HTTP method: GET, HEAD, POST, PUT etc.
</span><span style="color:#e6db74">     * @throws RuntimeException
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct(<span style="color:#a6e22e">MyHttpClient</span> $client, $host, $resource, $method) {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">http_client</span> <span style="color:#f92672">=</span> $client;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">host</span> <span style="color:#f92672">=</span> $host;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resource</span> <span style="color:#f92672">=</span> $resource;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">method</span> <span style="color:#f92672">=</span> $method;
      
        <span style="color:#75715e">// 获取http服务器的端口
</span><span style="color:#75715e"></span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">service_port</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getservbyname</span>(<span style="color:#e6db74">&#39;www&#39;</span>, <span style="color:#e6db74">&#39;tcp&#39;</span>); 
        <span style="color:#75715e">// 获取host的ip地址
</span><span style="color:#75715e"></span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">address</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gethostbyname</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">host</span>);
        <span style="color:#75715e">//创建一个TCP/IP socket
</span><span style="color:#75715e"></span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket_create</span>(<span style="color:#a6e22e">AF_INET</span>, <span style="color:#a6e22e">SOCK_STREAM</span>, <span style="color:#a6e22e">SOL_TCP</span>);
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>) {
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RuntimeException</span>(<span style="color:#e6db74">&#34;socket_create() failed: reason: &#34;</span> <span style="color:#f92672">.</span>         <span style="color:#a6e22e">socket_strerror</span>(<span style="color:#a6e22e">socket_last_error</span>()));
        }
      
        <span style="color:#75715e">// 设置进程非阻塞
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">socket_set_nonblock</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">conn_watcher</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">http_client</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getLoop</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">timer</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.</span>, [$this, <span style="color:#e6db74">&#39;connect&#39;</span>]);
    }
  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __destruct() {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">close</span>();
    }
  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">freeWatcher</span>(<span style="color:#f92672">&amp;</span>$w) {
        <span style="color:#66d9ef">if</span> ($w) {
            $w<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stop</span>();
            $w <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
        }
    }
  
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 释放所有的请求资源
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">close</span>() {
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>) {
            <span style="color:#a6e22e">socket_close</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>);
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
        }
      
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">freeWatcher</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">timeout_watcher</span>);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">freeWatcher</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read_watcher</span>);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">freeWatcher</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">write_watcher</span>);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">freeWatcher</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">conn_watcher</span>);
    }
  
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 初始化一个socket连接
</span><span style="color:#e6db74">     * return bool
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">connect</span>() {
        $loop <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">http_client</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getLoop</span>();
      
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">timeout_watcher</span> <span style="color:#f92672">=</span> $loop<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">timer</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">timeout</span>, <span style="color:#ae81ff">0</span>, [$this, <span style="color:#e6db74">&#39;_onTimeout&#39;</span>]);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">write_watcher</span> <span style="color:#f92672">=</span> $loop<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">io</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>, <span style="color:#a6e22e">Ev</span><span style="color:#f92672">::</span><span style="color:#a6e22e">WRITE</span>, [$this, <span style="color:#e6db74">&#39;_onWritable&#39;</span>]);
      
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">socket_connect</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">address</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">service_port</span>);
    }
    
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 超时观察者程序的回调程序
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_onTimeout</span>(<span style="color:#a6e22e">EvTimer</span> $w) {
        $w<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stop</span>();
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">close</span>();
    }
  
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * socket变为可写时的回调方法
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_onWritable</span>(<span style="color:#a6e22e">EvIo</span> $w) {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">timeout_watcher</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stop</span>(); 
        $w<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stop</span>();

        $in <span style="color:#f92672">=</span> <span style="color:#a6e22e">implode</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, [
            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>$this-&gt;method<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>$this-&gt;resource<span style="color:#e6db74">}</span><span style="color:#e6db74"> HTTP/1.1&#34;</span>, 
            <span style="color:#e6db74">&#34;Host: </span><span style="color:#e6db74">{</span>$this-&gt;host<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
            <span style="color:#e6db74">&#39;Connection: Close&#39;</span>,
        ]) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>;
      
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">socket_write</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>, $in, <span style="color:#a6e22e">strlen</span>($in))) { 
            <span style="color:#a6e22e">trigger_error</span>(<span style="color:#e6db74">&#34;Failed writing </span><span style="color:#e6db74">$in</span><span style="color:#e6db74"> to socket&#34;</span>, <span style="color:#a6e22e">E_USER_ERROR</span>); 
            <span style="color:#66d9ef">return</span>;
        }
      
        $loop <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">http_client</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getLoop</span>();
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read_watcher</span> <span style="color:#f92672">=</span> $loop<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">io</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>, <span style="color:#a6e22e">Ev</span><span style="color:#f92672">::</span><span style="color:#a6e22e">READ</span>, [$this, <span style="color:#e6db74">&#39;_onReadable&#39;</span>]);

        <span style="color:#75715e">// Continue running the loop
</span><span style="color:#75715e"></span>        $loop<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">run</span>();
    }
   
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 可读时的回调方法
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_onReadable</span>(<span style="color:#a6e22e">EvIo</span> $w) {
        <span style="color:#75715e">// recv() 20 bytes in non-blocking mode
</span><span style="color:#75715e"></span>        $ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket_recv</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">socket</span>, $out, <span style="color:#ae81ff">20</span>, <span style="color:#a6e22e">MSG_DONTWAIT</span>);
        
        <span style="color:#66d9ef">if</span> ($ret) {
        <span style="color:#75715e">// 有数据就把数据追加大buffer中
</span><span style="color:#75715e"></span>            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">buffer</span> <span style="color:#f92672">.=</span> $out;
        } <span style="color:#66d9ef">elseif</span> ($ret <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#75715e">// 读完之后
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&lt;&lt;&lt;&lt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&gt;&gt;&gt;&gt;&#34;</span>, <span style="color:#a6e22e">rtrim</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">buffer</span>)); 
            <span style="color:#a6e22e">fflush</span>(<span style="color:#a6e22e">STDOUT</span>);
            $w<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stop</span>();
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">close</span>();
            <span style="color:#66d9ef">return</span>;
        }
        
        <span style="color:#75715e">// Caught EINPROGRESS, EAGAIN, or EWOULDBLOCK
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">in_array</span>(<span style="color:#a6e22e">socket_last_error</span>(), <span style="color:#66d9ef">static</span><span style="color:#f92672">::</span>$e_nonblocking)) {
            <span style="color:#66d9ef">return</span>;
        }
      
        $w<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stop</span>();
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">close</span>();
    }
}    

<span style="color:#75715e">/////////////////////////////////////
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHttpClient</span> {
    <span style="color:#75715e">// @var array Instances of MyHttpRequest 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $requests <span style="color:#f92672">=</span> [];
    <span style="color:#75715e">// @var EvLoop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> $loop;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct() {
        <span style="color:#75715e">// Each HTTP client runs its own event loop 
</span><span style="color:#75715e"></span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">loop</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EvLoop</span>();
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __destruct() { 
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">loop</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stop</span>();
    }
  
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @return EvLoop
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getLoop</span>() { 
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">loop</span>;
    }
    
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Adds a pending request
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addRequest</span>(<span style="color:#a6e22e">MyHttpRequest</span> $r) { 
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">requests</span> []<span style="color:#f92672">=</span> $r;
    }
  
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Dispatches all pending requests
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>() { 
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">loop</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">run</span>();
    } 
}

<span style="color:#75715e">///////////////////////////////////// // Usage
</span><span style="color:#75715e"></span>$client <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MyHttpClient</span>(); 
<span style="color:#66d9ef">foreach</span> (<span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">as</span> $i) {
    $client<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addRequest</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MyHttpRequest</span>($client, <span style="color:#e6db74">&#39;my-host.local&#39;</span>, <span style="color:#e6db74">&#39;/test.php?a=&#39;</span> <span style="color:#f92672">.</span> $i, <span style="color:#e6db74">&#39;GET&#39;</span>)); 
}
$client<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">run</span>();
</code></pre></div><p><strong>测试</strong></p>
<p>假设<code>http://my-host.local/test.php</code>脚本在打印输出<code>$_GET</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;GET: &#39;</span>, <span style="color:#a6e22e">var_export</span>($_GET, <span style="color:#66d9ef">true</span>), <span style="color:#a6e22e">PHP_EOL</span>;
</code></pre></div><p><code>php http-client.php</code>的输出和下面的内容相似：</p>
<pre><code>&lt;&lt;&lt;&lt;
HTTP/1.1 200 OK
Server: nginx/1.10.1
Date: Fri, 02 Dec 2016 12:39:54 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: close
X-Powered-By: PHP/7.0.13-pl0-gentoo

1d
GET: array (
    'a' =&gt; '3', 
)

0
&gt;&gt;&gt;&gt;
&lt;&lt;&lt;&lt;
HTTP/1.1 200 OK
Server: nginx/1.10.1
Date: Fri, 02 Dec 2016 12:39:54 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: close
X-Powered-By: PHP/7.0.13-pl0-gentoo

1d
GET: array (
    'a' =&gt; '2', 
)

0 
&gt;&gt;&gt;&gt; 
...
</code></pre><p>注意：PHP 5的socket扩展可能会输出<code>EINPROGRESS</code>, <code>EAGAIN</code>, <code>EWOULDBLOCK</code>的<code>errno</code>值。可以通过<code>error_reporting(E_ERROR);</code>关闭日志。</p>
<h3 id="7-使用amp事件循环">7 使用AMP事件循环</h3>
<p>使用AMP实现。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">require __DIR__ . &#39;/vendor/autoload.php&#39;;

use Amp\Dns;

// Try our system defined resolver or googles, whichever is fastest
function queryStackOverflow($recordtype) { 
    $requests = [
        Dns\query(&#34;stackoverflow.com&#34;, $recordtype),
        Dns\query(&#34;stackoverflow.com&#34;, $recordtype, [&#34;server&#34; =&gt; &#34;8.8.8.8&#34;]),
    ];
    // returns a Promise resolving when the first one of the requests resolves
    return yield Amp\first($request);
}

\Amp\run(function() { // main loop, implicitly a coroutine 
    try {
        // convert to coroutine with Amp\resolve()
        $promise = Amp\resolve(queryStackOverflow(Dns\Record::NS)); 
        list($ns, $type, $ttl) = // we need only one NS result, not all
            current(yield Amp\timeout($promise, 2000 /* milliseconds */)); 
        echo &#34;The result of the fastest server to reply to our query was $ns&#34;;
    } catch (Amp\TimeoutException $e) {
        echo &#34;We&#39;ve heard no answer for 2 seconds! Bye!&#34;;
    } catch (Dns\NoRecordException $e) {
        echo &#34;No NS records there? Stupid DNS nameserver!&#34;;
    }
});
</code></pre></div><p>参考：<a href="https://goalkicker.com/PHPBook">PHP® Notes for Professionals book</a></p>

        
                
        
              <hr>
              <ul class="pager">
                  
                  <li class="previous">
                      <a href="/2019/06/post/mysql-section-55.html" data-toggle="tooltip" data-placement="top" title="MySQL专业笔记(五十五)">&larr; Previous Post</a>
                  </li>
                  
                  
                  <li class="next">
                      <a href="/2019/06/post/mysql-section-56.html" data-toggle="tooltip" data-placement="top" title="MySQL专业笔记(五十六)">Next Post &rarr;</a>
                  </li>
                  
              </ul>
  
              
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">特色标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/algorithms" title="algorithms">
                        algorithms
                        </a>
                        
                        
                        
                        <a href="/tags/bash" title="bash">
                        bash
                        </a>
                        
                        
                        
                        <a href="/tags/git" title="git">
                        git
                        </a>
                        
                        
                        
                        <a href="/tags/go" title="go">
                        go
                        </a>
                        
                        
                        
                        <a href="/tags/hugo" title="hugo">
                        hugo
                        </a>
                        
                        
                        
                        <a href="/tags/java" title="java">
                        java
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                        linux
                        </a>
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                        mysql
                        </a>
                        
                        
                        
                        <a href="/tags/php" title="php">
                        php
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                    
                    
                    
                    
                    

                    

		    
                    
                    
                    
                    
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 怀府小阁 , 2019
                    <br>

                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>




<script>
    
    var _baId = '60e88bb5add74ae0f8d6971f23b916ce';

    
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>




</body>
</html>
